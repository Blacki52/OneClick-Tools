<script>
// ... (previous HTML and CSS remains the same) ...

const display = document.getElementById('display');
const historyDisplay = document.getElementById('history');
let currentInput = '0';
let previousInput = '';
let operation = null;
let resetInput = false;
let openParenthesesCount = 0; // Track unclosed parentheses

function updateDisplay() {
    display.textContent = currentInput;
}

function appendNumber(number) {
    if (currentInput === '0' || resetInput) {
        currentInput = number;
        resetInput = false;
    } else if (currentInput.length < 20) {
        currentInput += number;
    }
    updateDisplay();
}

function handleOperator(op) {
    if (operation !== null) calculate();
    previousInput = currentInput;
    operation = op;
    resetInput = true;
    historyDisplay.textContent = `${previousInput} ${operation}`;
}

function addFunction(func) {
    if (resetInput) {
        currentInput = func;
        resetInput = false;
    } else {
        currentInput += func;
    }
    if (func.includes('(')) openParenthesesCount++;
    updateDisplay();
}

function addParenthesis(paren) {
    if (resetInput) {
        currentInput = paren;
        resetInput = false;
    } else {
        currentInput += paren;
    }
    if (paren === '(') openParenthesesCount++;
    else if (paren === ')') openParenthesesCount = Math.max(0, openParenthesesCount - 1);
    updateDisplay();
}

function calculate() {
    try {
        // Balance parentheses if needed
        while (openParenthesesCount > 0) {
            currentInput += ')';
            openParenthesesCount--;
        }

        // Convert display symbols to JavaScript math
        let expression = currentInput
            .replace(/×/g, '*')
            .replace(/−/g, '-')
            .replace(/\^/g, '**')
            .replace(/!/g, 'factorial(')
            .replace(/√/g, 'Math.sqrt(')
            .replace(/log\(/g, 'Math.log10(')
            .replace(/ln\(/g, 'Math.log(')
            .replace(/sin\(/g, 'Math.sin(Math.PI/180*')  // Convert degrees to radians
            .replace(/cos\(/g, 'Math.cos(Math.PI/180*')
            .replace(/tan\(/g, 'Math.tan(Math.PI/180*');

        // Custom factorial function with counting
        function factorial(n) {
            if (n < 0) return NaN;
            if (n <= 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        // Count operations and validate
        const operationCount = (expression.match(/[\+\-\*\/\^]/g) || []).length;
        const functionCount = (expression.match(/Math\.\w+\(/g) || []).length;
        
        let result = eval(expression);
        
        if (isNaN(result) || !isFinite(result)) {
            currentInput = 'Error';
        } else {
            // Format result based on operation count
            currentInput = Number.isInteger(result) ? 
                result.toString() : 
                parseFloat(result.toFixed(10)).toString();
        }
        
        operation = null;
        resetInput = true;
        historyDisplay.textContent = '';
        updateDisplay();
    } catch (error) {
        currentInput = 'Error';
        updateDisplay();
    }
}

// ... (rest of the code remains the same) ...
</script>
